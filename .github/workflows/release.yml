name: Publish

on:
  push:
    branches:
      - master

jobs:
  release:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Install dependencies
        run: dart pub get

      - name: Bump version
        id: bump
        run: |
          VERSION=$(dart run tool/bump_version.dart)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Format source
        run: dart format .

      - name: Analyze
        run: dart analyze

      - name: Run tests
        run: dart test

      - name: Commit release changes
        id: commit
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: release v${{ steps.bump.outputs.version }}"
            echo "committed=true" >> "$GITHUB_OUTPUT"
          else
            echo "committed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure pub.dev authentication
        id: auth
        if: steps.commit.outputs.committed == 'true'
        env:
          PUB_API_TOKEN: ${{ secrets.PUB_API_TOKEN }}
          PUB_CREDENTIALS_JSON: ${{ secrets.PUB_CREDENTIALS_JSON }}
        run: |
          set -e
          if [[ -n "$PUB_API_TOKEN" ]]; then
            echo "Using API token for pub.dev"
            dart pub token add https://pub.dev "$PUB_API_TOKEN"
            echo "configured=true" >> "$GITHUB_OUTPUT"
          elif [[ -n "$PUB_CREDENTIALS_JSON" ]]; then
            echo "Using legacy credentials.json"
            mkdir -p "$HOME/.pub-cache" "$HOME/.dart"
            printf '%s' "$PUB_CREDENTIALS_JSON" > "$HOME/.pub-cache/credentials.json"
            printf '%s' "$PUB_CREDENTIALS_JSON" > "$HOME/.dart/pub-credentials.json"
            chmod 600 "$HOME/.pub-cache/credentials.json" "$HOME/.dart/pub-credentials.json"
            if command -v jq >/dev/null 2>&1; then
              jq '.hosted["pub.dev"] | {hasAccessToken: has("accessToken"), hasRefreshToken: has("refreshToken"), expiry: .expiry}' "$HOME/.pub-cache/credentials.json" || echo "Impossibile parsare credentials.json"
            fi
            echo "configured=true" >> "$GITHUB_OUTPUT"
          else
            echo "No pub.dev authentication secrets provided (PUB_API_TOKEN or PUB_CREDENTIALS_JSON). Skipping publish."
            echo "configured=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish to pub.dev
        if: steps.commit.outputs.committed == 'true' && steps.auth.outputs.configured == 'true'
        run: dart pub publish --force

      - name: Push changes and tag
        if: steps.commit.outputs.committed == 'true'
        env:
          VERSION: ${{ steps.bump.outputs.version }}
        run: |
          git tag "v$VERSION"
          git push origin HEAD
          git push origin "v$VERSION"
